#if __DESIGNER_DATA
#error Do not define __DESIGNER_DATA.
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<om:MetaModel MajorVersion="1" MinorVersion="3" Core="2b131234-7959-458d-834f-2dc0769ce683" ScheduleModel="66366196-361d-448d-976f-cab5e87496d2" xmlns:om="http://schemas.microsoft.com/BizTalk/2003/DesignerData">
    <om:Element Type="Module" OID="f895d2c4-33fb-4007-87f9-71ad04440909" LowerBound="1.1" HigherBound="68.1">
        <om:Property Name="ReportToAnalyst" Value="True" />
        <om:Property Name="Name" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations" />
        <om:Property Name="Signal" Value="False" />
        <om:Element Type="PortType" OID="b0fb8e21-fd14-4f44-b65c-16660d077832" ParentLink="Module_PortType" LowerBound="4.1" HigherBound="11.1">
            <om:Property Name="Synchronous" Value="False" />
            <om:Property Name="TypeModifier" Value="Public" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="ContactBrokerPortType" />
            <om:Property Name="Signal" Value="False" />
            <om:Element Type="OperationDeclaration" OID="5e2fbdb2-23af-435a-aa0b-267b8e612a76" ParentLink="PortType_OperationDeclaration" LowerBound="6.1" HigherBound="10.1">
                <om:Property Name="OperationType" Value="OneWay" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="Operation_ContactBroker" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="MessageRef" OID="98796b4a-03fe-45ba-b261-99ecde799b9c" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="8.13" HigherBound="8.75">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="PortType" OID="7b33981e-17e7-41f2-a756-fe82ba500abe" ParentLink="Module_PortType" LowerBound="11.1" HigherBound="18.1">
            <om:Property Name="Synchronous" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="SendBrokerEmailType" />
            <om:Property Name="Signal" Value="False" />
            <om:Element Type="OperationDeclaration" OID="a9ff19c8-9f00-45e7-993c-93632d07ac3c" ParentLink="PortType_OperationDeclaration" LowerBound="13.1" HigherBound="17.1">
                <om:Property Name="OperationType" Value="OneWay" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="Operation_1" />
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="MessageRef" OID="46dfcb98-4bfa-4e98-80ba-46eaf9a5412d" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="15.13" HigherBound="15.75">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="ServiceDeclaration" OID="b08a9d44-5869-48d2-b3c6-d2a522aa520c" ParentLink="Module_ServiceDeclaration" LowerBound="25.1" HigherBound="67.1">
            <om:Property Name="InitializedTransactionType" Value="False" />
            <om:Property Name="IsInvokable" Value="True" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="ConfirmOrderWithBroker" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="ServiceLinkDeclaration" OID="d4bb9a26-3b03-466c-b172-7359072f2e08" ParentLink="ServiceDeclaration_ServiceLinkDeclaration" LowerBound="28.1" HigherBound="29.1">
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="7" />
                <om:Property Name="PortModifier" Value="Uses" />
                <om:Property Name="RoleName" Value="ContactBroker_Role" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.BrokerLinkType" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="BrokerRoleLink" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="81e09ee5-646a-4375-9706-bf1277b759e6" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="31.1" HigherBound="32.1">
                <om:Property Name="InitialValue" Value="false" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.Boolean" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="bFailed" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="ServiceBody" OID="3cfabadd-aa4f-4a8e-90cd-1a1838c1fcc1" ParentLink="ServiceDeclaration_ServiceBody">
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="VariableDeclaration" OID="b1f10587-bca1-4fcd-9338-444d533fea12" ParentLink="ServiceBody_Declaration" LowerBound="32.15" HigherBound="32.37">
                    <om:Property Name="UseDefaultConstructor" Value="False" />
                    <om:Property Name="Type" Value="System.String" />
                    <om:Property Name="ParamDirection" Value="In" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="brokerID" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="MessageDeclaration" OID="cd134a9d-fa18-4724-90f3-faae6374121b" ParentLink="ServiceBody_Declaration" LowerBound="32.39" HigherBound="32.122">
                    <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                    <om:Property Name="ParamDirection" Value="In" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="OrderMessage" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="VariableDeclaration" OID="7b55e40f-949d-4e7e-86c2-caab9357244c" ParentLink="ServiceBody_Declaration" LowerBound="32.124" HigherBound="32.149">
                    <om:Property Name="UseDefaultConstructor" Value="False" />
                    <om:Property Name="Type" Value="System.String" />
                    <om:Property Name="ParamDirection" Value="In" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="destination" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="Scope" OID="ba1df4b7-51f0-4aa1-acd5-501d36ef55b1" ParentLink="ServiceBody_Statement" LowerBound="35.1" HigherBound="57.1">
                    <om:Property Name="InitializedTransactionType" Value="True" />
                    <om:Property Name="IsSynchronized" Value="False" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Send Partial order to partner" />
                    <om:Property Name="Signal" Value="True" />
                    <om:Element Type="VariableAssignment" OID="ebbaff51-5448-40c5-99bc-b3d7930940b3" ParentLink="ComplexStatement_Statement" LowerBound="40.1" HigherBound="42.1">
                        <om:Property Name="Expression" Value="BrokerRoleLink(Microsoft.XLANGs.BaseTypes.DestinationParty) = new Microsoft.XLANGs.BaseTypes.Party(brokerID,&quot;OrganizationName&quot;);" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="InitializeBrokerRoleLink" />
                        <om:Property Name="Signal" Value="False" />
                    </om:Element>
                    <om:Element Type="Send" OID="a06d07ea-dd7a-475e-8121-4352836063a5" ParentLink="ComplexStatement_Statement" LowerBound="42.1" HigherBound="44.1">
                        <om:Property Name="MessageName" Value="OrderMessage" />
                        <om:Property Name="OperationName" Value="Operation_ContactBroker" />
                        <om:Property Name="OperationMessageName" Value="Request" />
                        <om:Property Name="ServiceLinkName" Value="BrokerRoleLink" />
                        <om:Property Name="ServiceLinkPortTypeName" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ContactBrokerPortType" />
                        <om:Property Name="ServiceLinkRoleName" Value="ContactBroker_Role" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="SendOrderDetails" />
                        <om:Property Name="Signal" Value="True" />
                    </om:Element>
                    <om:Element Type="Catch" OID="db1fa614-8fdf-479e-9b7a-633e673ead3e" ParentLink="Scope_Catch" LowerBound="47.1" HigherBound="55.1">
                        <om:Property Name="ExceptionName" Value="exp" />
                        <om:Property Name="ExceptionType" Value="System.Exception" />
                        <om:Property Name="IsFaultMessage" Value="False" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="FailedToSend" />
                        <om:Property Name="Signal" Value="True" />
                        <om:Element Type="VariableAssignment" OID="966d686f-99f7-4c38-94d7-dc5b4f961e87" ParentLink="Catch_Statement" LowerBound="50.1" HigherBound="52.1">
                            <om:Property Name="Expression" Value="bFailed = true;" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="bFailed = true" />
                            <om:Property Name="Signal" Value="False" />
                        </om:Element>
                        <om:Element Type="VariableAssignment" OID="c7645da1-1ce8-4560-9a46-1bf56cc20504" ParentLink="Catch_Statement" LowerBound="52.1" HigherBound="54.1">
                            <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Unable to initialize rolelink OR party not enlisted  for Broker = &quot; + brokerID + &quot;. Exception ocurred: &quot;+ exp.Message, System.Diagnostics.EventLogEntryType.Error);" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Notify Admin" />
                            <om:Property Name="Signal" Value="False" />
                        </om:Element>
                    </om:Element>
                </om:Element>
                <om:Element Type="Decision" OID="438a2b29-e7da-4c8d-b6b4-72cd20e35cfa" ParentLink="ServiceBody_Statement" LowerBound="57.1" HigherBound="65.1">
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="GotEmail" />
                    <om:Property Name="Signal" Value="True" />
                    <om:Element Type="DecisionBranch" OID="968e8aa4-3b81-478c-a126-c013e9dfe521" ParentLink="ReallyComplexStatement_Branch" LowerBound="58.13" HigherBound="65.1">
                        <om:Property Name="Expression" Value="null != destination &amp;&amp; false == bFailed" />
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="null != destination" />
                        <om:Property Name="Signal" Value="False" />
                        <om:Element Type="VariableAssignment" OID="9b95ae86-2c3b-4216-a6de-826f4dd7132b" ParentLink="ComplexStatement_Statement" LowerBound="60.1" HigherBound="62.1">
                            <om:Property Name="Expression" Value="SendBrokerEmail(Microsoft.XLANGs.BaseTypes.Address) = destination;&#xD;&#xA;" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="IntializeSendPort" />
                            <om:Property Name="Signal" Value="False" />
                        </om:Element>
                        <om:Element Type="Send" OID="9337532d-fb3b-41f7-a4ca-bbfb2f6a7ba9" ParentLink="ComplexStatement_Statement" LowerBound="62.1" HigherBound="64.1">
                            <om:Property Name="PortName" Value="SendBrokerEmail" />
                            <om:Property Name="MessageName" Value="OrderMessage" />
                            <om:Property Name="OperationName" Value="Operation_1" />
                            <om:Property Name="OperationMessageName" Value="Request" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Send Order by Mail" />
                            <om:Property Name="Signal" Value="True" />
                        </om:Element>
                    </om:Element>
                    <om:Element Type="DecisionBranch" OID="0d1bade9-a1c2-412c-9ed8-7c9e7f1d1883" ParentLink="ReallyComplexStatement_Branch">
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="Else" />
                        <om:Property Name="Signal" Value="False" />
                    </om:Element>
                </om:Element>
            </om:Element>
            <om:Element Type="PortDeclaration" OID="cca3ef2c-7901-4f8e-912f-74222ee2df06" ParentLink="ServiceDeclaration_PortDeclaration" LowerBound="29.1" HigherBound="31.1">
                <om:Property Name="PortModifier" Value="Uses" />
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="30" />
                <om:Property Name="IsWebPort" Value="False" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.SendBrokerEmailType" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="SendBrokerEmail" />
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="PhysicalBindingAttribute" OID="17934238-3142-4916-be5c-684311f219c4" ParentLink="PortDeclaration_CLRAttribute" LowerBound="29.1" HigherBound="30.1">
                    <om:Property Name="InPipeline" Value="Microsoft.BizTalk.DefaultPipelines.XMLReceive" />
                    <om:Property Name="OutPipeline" Value="Microsoft.BizTalk.DefaultPipelines.XMLTransmit" />
                    <om:Property Name="TransportType" Value="HTTP" />
                    <om:Property Name="URI" Value="http://tempURI" />
                    <om:Property Name="IsDynamic" Value="True" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="ServiceLinkType" OID="cf014de9-529f-4fdd-b862-2358204fee1a" ParentLink="Module_ServiceLinkType" LowerBound="18.1" HigherBound="25.1">
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="BrokerLinkType" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="RoleDeclaration" OID="f109ea27-3081-49b4-b9df-cdf8c6aa46b4" ParentLink="ServiceLinkType_RoleDeclaration" LowerBound="20.1" HigherBound="24.1">
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="ContactBroker_Role" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="PortTypeRef" OID="5b90ccc3-2ec8-4d68-a2d5-81f454753c0b" ParentLink="RoleDeclaration_PortTypeRef" LowerBound="22.13" HigherBound="22.34">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ContactBrokerPortType" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="PortTypeRef_1" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
    </om:Element>
</om:MetaModel>
#endif // __DESIGNER_DATA
[Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
module Microsoft.Samples.BizTalk.Litware.Orchestrations
{
    public porttype ContactBrokerPortType
    {
        oneway Operation_ContactBroker
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder
        };
    };
    internal porttype SendBrokerEmailType
    {
        oneway Operation_1
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder
        };
    };
    internal servicelinktype BrokerLinkType
    {
        ContactBroker_Role
        {
            ContactBrokerPortType
        };
    };
    [Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
    internal service ConfirmOrderWithBroker
    {
        servicelink uses BrokerLinkType.ContactBroker_Role BrokerRoleLink;
        [Microsoft.XLANGs.BaseTypes.PhysicalBinding(typeof(Microsoft.BizTalk.DefaultPipelines.XMLTransmit))]
        port uses dynamic SendBrokerEmailType SendBrokerEmail;
        System.Boolean bFailed;
        body (System.String brokerID, message Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder OrderMessage, System.String destination)
        {
            bFailed = false;
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("ba1df4b7-51f0-4aa1-acd5-501d36ef55b1")]
            scope
            {
                body
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("ebbaff51-5448-40c5-99bc-b3d7930940b3")]
                    BrokerRoleLink(Microsoft.XLANGs.BaseTypes.DestinationParty) = new Microsoft.XLANGs.BaseTypes.Party(brokerID,"OrganizationName");
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("a06d07ea-dd7a-475e-8121-4352836063a5")]
                    send (BrokerRoleLink[Microsoft.Samples.BizTalk.Litware.Orchestrations.ContactBrokerPortType].Operation_ContactBroker, OrderMessage);
                }
                exceptions
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("db1fa614-8fdf-479e-9b7a-633e673ead3e")]
                    catch (System.Exception exp)
                    {
                        [Microsoft.XLANGs.BaseTypes.DesignerPosition("966d686f-99f7-4c38-94d7-dc5b4f961e87")]
                        bFailed = true;
                        [Microsoft.XLANGs.BaseTypes.DesignerPosition("c7645da1-1ce8-4560-9a46-1bf56cc20504")]
                        System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Unable to initialize rolelink OR party not enlisted  for Broker = " + brokerID + ". Exception ocurred: "+ exp.Message, System.Diagnostics.EventLogEntryType.Error);
                    }
                }
            }
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("438a2b29-e7da-4c8d-b6b4-72cd20e35cfa")]
            if (null != destination && false == bFailed)
            {
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("9b95ae86-2c3b-4216-a6de-826f4dd7132b")]
                SendBrokerEmail(Microsoft.XLANGs.BaseTypes.Address) = destination;
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("9337532d-fb3b-41f7-a4ca-bbfb2f6a7ba9")]
                send (SendBrokerEmail.Operation_1, OrderMessage);
            }
        }
    }
}

