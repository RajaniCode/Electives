#if __DESIGNER_DATA
#error Do not define __DESIGNER_DATA.
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<om:MetaModel MajorVersion="1" MinorVersion="3" Core="2b131234-7959-458d-834f-2dc0769ce683" ScheduleModel="66366196-361d-448d-976f-cab5e87496d2" xmlns:om="http://schemas.microsoft.com/BizTalk/2003/DesignerData">
    <om:Element Type="Module" OID="d0d8aa3b-b56c-469e-b1ce-c533b35a8cb6" LowerBound="1.1" HigherBound="136.1">
        <om:Property Name="ReportToAnalyst" Value="True" />
        <om:Property Name="Name" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations" />
        <om:Property Name="Signal" Value="False" />
        <om:Element Type="PortType" OID="cefc58f9-8b06-479e-8914-b4548a5dba88" ParentLink="Module_PortType" LowerBound="4.1" HigherBound="11.1">
            <om:Property Name="Synchronous" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="RecvBasketPortType" />
            <om:Property Name="Signal" Value="False" />
            <om:Element Type="OperationDeclaration" OID="844d3b43-f7e8-431f-acad-da2c4945b029" ParentLink="PortType_OperationDeclaration" LowerBound="6.1" HigherBound="10.1">
                <om:Property Name="OperationType" Value="OneWay" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="RecvBasketOp" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="MessageRef" OID="edcc5969-4bb2-4528-8b59-e02d5d17e4a3" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="8.13" HigherBound="8.67">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="PortType" OID="8ab2e251-485e-49ee-bd27-5d378627d083" ParentLink="Module_PortType" LowerBound="11.1" HigherBound="18.1">
            <om:Property Name="Synchronous" Value="True" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="SendBasketPortType" />
            <om:Property Name="Signal" Value="False" />
            <om:Element Type="OperationDeclaration" OID="be3a4d12-8d70-449d-9730-118e8e7e61d4" ParentLink="PortType_OperationDeclaration" LowerBound="13.1" HigherBound="17.1">
                <om:Property Name="OperationType" Value="RequestResponse" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="SendBasketOp" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="MessageRef" OID="1e661c48-1679-4eb2-9a91-f757164135e8" ParentLink="OperationDeclaration_FaultMessageRef" LowerBound="15.132" HigherBound="15.218">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.OrderSystem.SystemFaultMessage" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="SystemFault" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="MessageRef" OID="2c7bfa8e-f753-4765-a360-1ed1d0ff1881" ParentLink="OperationDeclaration_FaultMessageRef" LowerBound="15.220" HigherBound="15.310">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.OrderSystem.BusinessFaultMessage" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="BusinessFault" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="MessageRef" OID="f0927b18-23e8-4703-8841-8ccef5fca50f" ParentLink="OperationDeclaration_ResponseMessageRef" LowerBound="15.69" HigherBound="15.130">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Response" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
                <om:Element Type="MessageRef" OID="5e554d23-04b5-4915-a5a6-5cbe39982a40" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="15.13" HigherBound="15.67">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="ServiceDeclaration" OID="ce07f2b6-2e96-4176-91ce-405063a228d4" ParentLink="Module_ServiceDeclaration" LowerBound="18.1" HigherBound="135.1">
            <om:Property Name="InitializedTransactionType" Value="False" />
            <om:Property Name="IsInvokable" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="NewOrder" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="VariableDeclaration" OID="9d277b98-6a00-409e-9b43-b83e9094eec2" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="28.1" HigherBound="29.1">
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.String" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="brokerID" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="ae8ac9e5-b9e0-4d4d-8dfd-624cb436929b" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="29.1" HigherBound="30.1">
                <om:Property Name="InitialValue" Value="true" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.Boolean" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="callFailed" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="ba11998f-e774-4bd4-9ba4-6bb7501b3569" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="30.1" HigherBound="31.1">
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.String" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="destination" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="302560ba-4054-4d91-8455-c0f50b8a1ee6" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="31.1" HigherBound="32.1">
                <om:Property Name="InitialValue" Value="0" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.Int32" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="retryCount" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="4415980e-5ad9-4815-83de-78be6b131073" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="25.1" HigherBound="26.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="BasketMessage" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="2b75b107-8154-478b-9093-a50a8aeed98e" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="26.1" HigherBound="27.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="ProfileMessage" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="a83bf4da-862e-452c-9eb7-c7d5d6b73047" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="27.1" HigherBound="28.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="OrderMessage" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="ServiceBody" OID="73b7af8b-6bce-4ebc-8b82-b7d4990f33f8" ParentLink="ServiceDeclaration_ServiceBody">
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="Receive" OID="ee2feadd-c1ab-4497-abce-4000110a13e2" ParentLink="ServiceBody_Statement" LowerBound="34.1" HigherBound="40.1">
                    <om:Property Name="Activate" Value="True" />
                    <om:Property Name="PortName" Value="RecvBasketPort" />
                    <om:Property Name="MessageName" Value="BasketMessage" />
                    <om:Property Name="OperationName" Value="RecvBasketOp" />
                    <om:Property Name="OperationMessageName" Value="Request" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Recv Basket" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="VariableAssignment" OID="321dfa50-56cc-44ad-8865-fd468734fc21" ParentLink="ServiceBody_Statement" LowerBound="40.1" HigherBound="42.1">
                    <om:Property Name="Expression" Value="brokerID = BasketMessage(Microsoft.Samples.BizTalk.Litware.Schemas.SoldToName);" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="GetBrokerID" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
                <om:Element Type="Call" OID="7ba8c95e-3e3f-4d25-95b2-ac1f7175c13e" ParentLink="ServiceBody_Statement" LowerBound="42.1" HigherBound="44.1">
                    <om:Property Name="Identifier" Value="GetProfile" />
                    <om:Property Name="Invokee" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.GetUserProfile" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Get Profile" />
                    <om:Property Name="Signal" Value="False" />
                    <om:Element Type="Parameter" OID="47236788-39f6-4144-8806-0cfc2a315cbc" ParentLink="InvokeStatement_Parameter">
                        <om:Property Name="Direction" Value="In" />
                        <om:Property Name="Name" Value="brokerID" />
                        <om:Property Name="Type" Value="System.String" />
                        <om:Property Name="Signal" Value="False" />
                    </om:Element>
                    <om:Element Type="Parameter" OID="c08f0acb-8ead-431d-a071-cab6124ee2be" ParentLink="InvokeStatement_Parameter">
                        <om:Property Name="Direction" Value="Out" />
                        <om:Property Name="Name" Value="ProfileMessage" />
                        <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject" />
                        <om:Property Name="Signal" Value="False" />
                    </om:Element>
                    <om:Element Type="Parameter" OID="48935217-6cd7-4641-846c-5968742615e7" ParentLink="InvokeStatement_Parameter">
                        <om:Property Name="Direction" Value="Ref" />
                        <om:Property Name="Name" Value="callFailed" />
                        <om:Property Name="Type" Value="System.Boolean" />
                        <om:Property Name="Signal" Value="False" />
                    </om:Element>
                </om:Element>
                <om:Element Type="Decision" OID="112d2ae4-c95b-411f-a921-a5484114c56f" ParentLink="ServiceBody_Statement" LowerBound="44.1" HigherBound="133.1">
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Check ??" />
                    <om:Property Name="Signal" Value="True" />
                    <om:Element Type="DecisionBranch" OID="054169b3-5446-4506-9b88-fa3945a29040" ParentLink="ReallyComplexStatement_Branch" LowerBound="45.13" HigherBound="128.1">
                        <om:Property Name="Expression" Value="false == callFailed" />
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="Profile Exist" />
                        <om:Property Name="Signal" Value="True" />
                        <om:Element Type="VariableAssignment" OID="38e3d616-09c7-4abc-a9f9-2e46c835b4c4" ParentLink="ComplexStatement_Statement" LowerBound="47.1" HigherBound="49.1">
                            <om:Property Name="Expression" Value="destination = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.GetPartnerEmail(ProfileMessage);" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Get Email" />
                            <om:Property Name="Signal" Value="True" />
                        </om:Element>
                        <om:Element Type="Construct" OID="306f5904-47c1-4fcc-80ab-a22846d1fb1c" ParentLink="ComplexStatement_Statement" LowerBound="49.1" HigherBound="55.1">
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Create Empty PO" />
                            <om:Property Name="Signal" Value="True" />
                            <om:Element Type="MessageAssignment" OID="f250caae-26a0-4774-9489-707f3abf21c0" ParentLink="ComplexStatement_Statement" LowerBound="52.1" HigherBound="54.1">
                                <om:Property Name="Expression" Value="OrderMessage = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyOrderMessage();" />
                                <om:Property Name="ReportToAnalyst" Value="False" />
                                <om:Property Name="Name" Value="Empty PO" />
                                <om:Property Name="Signal" Value="True" />
                            </om:Element>
                            <om:Element Type="MessageRef" OID="446d3dd2-5744-42c6-b370-44382aa50522" ParentLink="Construct_MessageRef" LowerBound="50.27" HigherBound="50.39">
                                <om:Property Name="Ref" Value="OrderMessage" />
                                <om:Property Name="ReportToAnalyst" Value="True" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                        </om:Element>
                        <om:Element Type="While" OID="55df06b7-a68d-4806-acad-7802214f6020" ParentLink="ComplexStatement_Statement" LowerBound="55.1" HigherBound="123.1">
                            <om:Property Name="Expression" Value="retryCount &lt; 3" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Loop_1" />
                            <om:Property Name="Signal" Value="True" />
                            <om:Element Type="Scope" OID="d40cadfb-bf80-4b4d-94b8-8a55d2ee533b" ParentLink="ComplexStatement_Statement" LowerBound="58.1" HigherBound="122.1">
                                <om:Property Name="InitializedTransactionType" Value="True" />
                                <om:Property Name="IsSynchronized" Value="False" />
                                <om:Property Name="ReportToAnalyst" Value="True" />
                                <om:Property Name="Name" Value="Place Order" />
                                <om:Property Name="Signal" Value="False" />
                                <om:Element Type="Send" OID="70d20457-db52-4ae6-9f13-41431cce057b" ParentLink="ComplexStatement_Statement" LowerBound="63.1" HigherBound="65.1">
                                    <om:Property Name="PortName" Value="SendBasketPort" />
                                    <om:Property Name="MessageName" Value="BasketMessage" />
                                    <om:Property Name="OperationName" Value="SendBasketOp" />
                                    <om:Property Name="OperationMessageName" Value="Request" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="Send Basket to Backend" />
                                    <om:Property Name="Signal" Value="True" />
                                </om:Element>
                                <om:Element Type="Receive" OID="8952aa06-1693-4a79-8ae9-07e433e93db8" ParentLink="ComplexStatement_Statement" LowerBound="65.1" HigherBound="67.1">
                                    <om:Property Name="Activate" Value="False" />
                                    <om:Property Name="PortName" Value="SendBasketPort" />
                                    <om:Property Name="MessageName" Value="OrderMessage" />
                                    <om:Property Name="OperationName" Value="SendBasketOp" />
                                    <om:Property Name="OperationMessageName" Value="Response" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="Recv Order" />
                                    <om:Property Name="Signal" Value="True" />
                                </om:Element>
                                <om:Element Type="VariableAssignment" OID="2e7735cd-43ec-4558-9ed1-8675c3bf67ac" ParentLink="ComplexStatement_Statement" LowerBound="67.1" HigherBound="69.1">
                                    <om:Property Name="Expression" Value="retryCount = 3;" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="Break Loop" />
                                    <om:Property Name="Signal" Value="True" />
                                </om:Element>
                                <om:Element Type="Catch" OID="97972509-a1dd-4067-91c2-ceb9026b953f" ParentLink="Scope_Catch" LowerBound="72.1" HigherBound="78.1">
                                    <om:Property Name="ExceptionName" Value="OrderSystemBusinessException" />
                                    <om:Property Name="ExceptionType" Value="SendBasketPort.SendBasketOp.BusinessFault" />
                                    <om:Property Name="IsFaultMessage" Value="False" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="CatchBusinessException" />
                                    <om:Property Name="Signal" Value="True" />
                                    <om:Element Type="Terminate" OID="fb63d45a-bb33-49ef-8598-5e189bbb3a6f" ParentLink="Catch_Statement" LowerBound="75.1" HigherBound="77.1">
                                        <om:Property Name="ErrorMessage" Value="OrderSystemBusinessException.Message;" />
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Terminate  New Order" />
                                        <om:Property Name="Signal" Value="True" />
                                    </om:Element>
                                </om:Element>
                                <om:Element Type="Catch" OID="24d8b91b-7ee0-4814-b866-ea3f9dbcb35e" ParentLink="Scope_Catch" LowerBound="78.1" HigherBound="99.1">
                                    <om:Property Name="ExceptionName" Value="OrderSystemSystemFault" />
                                    <om:Property Name="ExceptionType" Value="SendBasketPort.SendBasketOp.SystemFault" />
                                    <om:Property Name="IsFaultMessage" Value="False" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="CatchSystemException" />
                                    <om:Property Name="Signal" Value="True" />
                                    <om:Element Type="VariableAssignment" OID="0958f0cb-b9cc-4ad2-89ba-527c888c37b4" ParentLink="Catch_Statement" LowerBound="81.1" HigherBound="83.1">
                                        <om:Property Name="Expression" Value="retryCount = retryCount + 1;" />
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Count" />
                                        <om:Property Name="Signal" Value="True" />
                                    </om:Element>
                                    <om:Element Type="Decision" OID="8f379ecb-303a-47f8-a71a-f80085e9af1c" ParentLink="Catch_Statement" LowerBound="83.1" HigherBound="98.1">
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Check Retry Count" />
                                        <om:Property Name="Signal" Value="True" />
                                        <om:Element Type="DecisionBranch" OID="15d3d604-41d9-4562-80f1-f2aaea83756d" ParentLink="ReallyComplexStatement_Branch" LowerBound="84.33" HigherBound="91.1">
                                            <om:Property Name="Expression" Value="retryCount &lt; 3" />
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="All Failed" />
                                            <om:Property Name="Signal" Value="True" />
                                            <om:Element Type="VariableAssignment" OID="80971834-6324-4e37-9ea1-7ab15ba8d7ef" ParentLink="ComplexStatement_Statement" LowerBound="86.1" HigherBound="88.1">
                                                <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Failed to publish order to Order System. Orchestration Suspended.&quot; + OrderSystemSystemFault.Message, System.Diagnostics.EventLogEntryType.Warning);" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Log Susp Error" />
                                                <om:Property Name="Signal" Value="False" />
                                            </om:Element>
                                            <om:Element Type="Suspend" OID="8ed15101-e555-4161-9887-9a6eaea18fa9" ParentLink="ComplexStatement_Statement" LowerBound="88.1" HigherBound="90.1">
                                                <om:Property Name="ErrorMessage" Value="&quot;Please check if your connection to the Order system is configured correctly.&quot;;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Suspend Update" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                        </om:Element>
                                        <om:Element Type="DecisionBranch" OID="59842827-bcda-45df-aeb7-d7fab01c3bc1" ParentLink="ReallyComplexStatement_Branch">
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="Else" />
                                            <om:Property Name="Signal" Value="False" />
                                            <om:Element Type="VariableAssignment" OID="74e4e6b4-d3e5-4ac4-a082-a8ed4b04743f" ParentLink="ComplexStatement_Statement" LowerBound="93.1" HigherBound="95.1">
                                                <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Failed to publish order to Order System after several retries. Orchestration Terminated.&quot; + OrderSystemSystemFault.Message, System.Diagnostics.EventLogEntryType.Error);" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Log Term Error" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                            <om:Element Type="Terminate" OID="77fbb591-e6f3-4a54-985d-b2470f60ba8f" ParentLink="ComplexStatement_Statement" LowerBound="95.1" HigherBound="97.1">
                                                <om:Property Name="ErrorMessage" Value="&quot;Cannot fulfill order as call to submit basket failed.&quot;;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Terminate Update" />
                                                <om:Property Name="Signal" Value="False" />
                                            </om:Element>
                                        </om:Element>
                                    </om:Element>
                                </om:Element>
                                <om:Element Type="Catch" OID="3624b7d4-3a4e-477a-b58e-60aee40dd138" ParentLink="Scope_Catch" LowerBound="99.1" HigherBound="120.1">
                                    <om:Property Name="ExceptionName" Value="ex" />
                                    <om:Property Name="ExceptionType" Value="System.Exception" />
                                    <om:Property Name="IsFaultMessage" Value="False" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="Catch Exception" />
                                    <om:Property Name="Signal" Value="True" />
                                    <om:Element Type="VariableAssignment" OID="2309fd43-dbbd-453c-9b4a-0d4edfe68b72" ParentLink="Catch_Statement" LowerBound="102.1" HigherBound="104.1">
                                        <om:Property Name="Expression" Value="retryCount = retryCount + 1;" />
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Inc Retry Count" />
                                        <om:Property Name="Signal" Value="False" />
                                    </om:Element>
                                    <om:Element Type="Decision" OID="90f99cdf-1abf-4726-b051-8adf831acd85" ParentLink="Catch_Statement" LowerBound="104.1" HigherBound="119.1">
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Check Retry Count" />
                                        <om:Property Name="Signal" Value="True" />
                                        <om:Element Type="DecisionBranch" OID="9bee73e2-6b4c-4ae2-be45-be2201eb7c9c" ParentLink="ReallyComplexStatement_Branch" LowerBound="105.33" HigherBound="112.1">
                                            <om:Property Name="Expression" Value="retryCount &lt; 3" />
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="All Failed" />
                                            <om:Property Name="Signal" Value="True" />
                                            <om:Element Type="VariableAssignment" OID="7cd07531-10af-413f-b893-7a2727fe68d8" ParentLink="ComplexStatement_Statement" LowerBound="107.1" HigherBound="109.1">
                                                <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Failed to publish order to Order System. Orchestration Suspended.&quot; + ex.Message, System.Diagnostics.EventLogEntryType.Warning);" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Log Susp Error" />
                                                <om:Property Name="Signal" Value="False" />
                                            </om:Element>
                                            <om:Element Type="Suspend" OID="76433813-a7eb-4250-b3f0-be34ca1fcf1b" ParentLink="ComplexStatement_Statement" LowerBound="109.1" HigherBound="111.1">
                                                <om:Property Name="ErrorMessage" Value="&quot;Please check if your connection to the Order system is configured correctly.&quot;;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Suspend Update" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                        </om:Element>
                                        <om:Element Type="DecisionBranch" OID="2ffebc8a-bdc3-4f80-9eb7-fd28e9dce35d" ParentLink="ReallyComplexStatement_Branch">
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="Else" />
                                            <om:Property Name="Signal" Value="False" />
                                            <om:Element Type="VariableAssignment" OID="df622c8d-0061-46f3-8d26-9eeb9c1edc8a" ParentLink="ComplexStatement_Statement" LowerBound="114.1" HigherBound="116.1">
                                                <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Failed to publish order to Order System after several retries. Orchestration Terminated.&quot; + ex.Message, System.Diagnostics.EventLogEntryType.Error);" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Log Term Error" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                            <om:Element Type="Terminate" OID="f34fa091-096f-4f29-93d6-6b0f5c09724f" ParentLink="ComplexStatement_Statement" LowerBound="116.1" HigherBound="118.1">
                                                <om:Property Name="ErrorMessage" Value="&quot;Cannot fulfill order as call to submit basket failed.&quot;;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Terminate Update" />
                                                <om:Property Name="Signal" Value="False" />
                                            </om:Element>
                                        </om:Element>
                                    </om:Element>
                                </om:Element>
                            </om:Element>
                        </om:Element>
                        <om:Element Type="Call" OID="a7bbf9f3-f0a0-4762-a408-bc2d76e60640" ParentLink="ComplexStatement_Statement" LowerBound="123.1" HigherBound="125.1">
                            <om:Property Name="Identifier" Value="VendorConfirm" />
                            <om:Property Name="Invokee" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ConfirmOrderWithVendors" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Vendor Confirm" />
                            <om:Property Name="Signal" Value="False" />
                            <om:Element Type="Parameter" OID="e087fd0b-7805-4c65-80e2-2a7bde84e966" ParentLink="InvokeStatement_Parameter">
                                <om:Property Name="Direction" Value="In" />
                                <om:Property Name="Name" Value="OrderMessage" />
                                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                        </om:Element>
                        <om:Element Type="Call" OID="8f2d4634-79e5-4678-a85a-995691e90153" ParentLink="ComplexStatement_Statement" LowerBound="125.1" HigherBound="127.1">
                            <om:Property Name="Identifier" Value="BrokerConfirm" />
                            <om:Property Name="Invokee" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ConfirmOrderWithBroker" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Broker Confirm" />
                            <om:Property Name="Signal" Value="False" />
                            <om:Element Type="Parameter" OID="ca97823d-68d0-4a42-b000-04fb3f85c208" ParentLink="InvokeStatement_Parameter">
                                <om:Property Name="Direction" Value="In" />
                                <om:Property Name="Name" Value="brokerID" />
                                <om:Property Name="Type" Value="System.String" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                            <om:Element Type="Parameter" OID="567b7c26-d033-4263-8f0f-29ffd6ca01be" ParentLink="InvokeStatement_Parameter">
                                <om:Property Name="Direction" Value="In" />
                                <om:Property Name="Name" Value="OrderMessage" />
                                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                            <om:Element Type="Parameter" OID="15c02884-f584-4fd1-9c30-61f77739ee6e" ParentLink="InvokeStatement_Parameter">
                                <om:Property Name="Direction" Value="In" />
                                <om:Property Name="Name" Value="destination" />
                                <om:Property Name="Type" Value="System.String" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                        </om:Element>
                    </om:Element>
                    <om:Element Type="DecisionBranch" OID="d1ea0e6c-b9ce-40fa-9d90-4b19329e3b84" ParentLink="ReallyComplexStatement_Branch">
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="Else" />
                        <om:Property Name="Signal" Value="False" />
                        <om:Element Type="VariableAssignment" OID="46b61cc7-1f3b-4ed4-8c33-4eacc41fbfcc" ParentLink="ComplexStatement_Statement" LowerBound="130.1" HigherBound="132.1">
                            <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Unable to find partner profile with Broker ID = &quot; + brokerID, System.Diagnostics.EventLogEntryType.Error);" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Notify Admin" />
                            <om:Property Name="Signal" Value="True" />
                        </om:Element>
                    </om:Element>
                </om:Element>
            </om:Element>
            <om:Element Type="PortDeclaration" OID="e2e59f23-a9fe-4bc8-a55a-091dfc58174c" ParentLink="ServiceDeclaration_PortDeclaration" LowerBound="21.1" HigherBound="23.1">
                <om:Property Name="PortModifier" Value="Implements" />
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="-1" />
                <om:Property Name="IsWebPort" Value="False" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.RecvBasketPortType" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="RecvBasketPort" />
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="LogicalBindingAttribute" OID="0aee0b96-b142-4c1f-80ef-c051871d4392" ParentLink="PortDeclaration_CLRAttribute" LowerBound="21.1" HigherBound="22.1">
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
            <om:Element Type="PortDeclaration" OID="c4ea67ad-2b07-4e38-b3ed-4432f13e7146" ParentLink="ServiceDeclaration_PortDeclaration" LowerBound="23.1" HigherBound="25.1">
                <om:Property Name="PortModifier" Value="Uses" />
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="46" />
                <om:Property Name="IsWebPort" Value="False" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.SendBasketPortType" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="SendBasketPort" />
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="LogicalBindingAttribute" OID="bbd18f71-ae78-4fcf-9ad1-e96ba3d9ee0b" ParentLink="PortDeclaration_CLRAttribute" LowerBound="23.1" HigherBound="24.1">
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
    </om:Element>
</om:MetaModel>
#endif // __DESIGNER_DATA
[Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
module Microsoft.Samples.BizTalk.Litware.Orchestrations
{
    internal porttype RecvBasketPortType
    {
        oneway RecvBasketOp
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket
        };
    };
    internal porttype SendBasketPortType
    {
        requestresponse SendBasketOp
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket, Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder, SystemFault = Microsoft.Samples.BizTalk.Litware.Schemas.OrderSystem.SystemFaultMessage, BusinessFault = Microsoft.Samples.BizTalk.Litware.Schemas.OrderSystem.BusinessFaultMessage
        };
    };
    [Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
    internal service NewOrder
    {
        [Microsoft.XLANGs.BaseTypes.LogicalBinding()]
        port implements RecvBasketPortType RecvBasketPort;
        [Microsoft.XLANGs.BaseTypes.LogicalBinding()]
        port uses SendBasketPortType SendBasketPort;
        message Microsoft.Samples.BizTalk.Litware.Schemas.Order.Basket BasketMessage;
        message Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject ProfileMessage;
        message Microsoft.Samples.BizTalk.Litware.Schemas.Order.PurchaseOrder OrderMessage;
        System.String brokerID;
        System.Boolean callFailed;
        System.String destination;
        System.Int32 retryCount;
        body ()
        {
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("ee2feadd-c1ab-4497-abce-4000110a13e2")]
            activate receive (RecvBasketPort.RecvBasketOp, BasketMessage);
            brokerID = "";
            callFailed = true;
            destination = "";
            retryCount = 0;
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("321dfa50-56cc-44ad-8865-fd468734fc21")]
            brokerID = BasketMessage(Microsoft.Samples.BizTalk.Litware.Schemas.SoldToName);
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("7ba8c95e-3e3f-4d25-95b2-ac1f7175c13e")]
            call Microsoft.Samples.BizTalk.Litware.Orchestrations.GetUserProfile (brokerID, out ProfileMessage, ref callFailed);
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("112d2ae4-c95b-411f-a921-a5484114c56f")]
            if (false == callFailed)
            {
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("38e3d616-09c7-4abc-a9f9-2e46c835b4c4")]
                destination = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.GetPartnerEmail(ProfileMessage);
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("306f5904-47c1-4fcc-80ab-a22846d1fb1c")]
                construct OrderMessage
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("f250caae-26a0-4774-9489-707f3abf21c0")]
                    OrderMessage = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyOrderMessage();
                }
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("55df06b7-a68d-4806-acad-7802214f6020")]
                while (retryCount < 3)
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("d40cadfb-bf80-4b4d-94b8-8a55d2ee533b")]
                    scope
                    {
                        body
                        {
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("70d20457-db52-4ae6-9f13-41431cce057b")]
                            send (SendBasketPort.SendBasketOp, BasketMessage);
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("8952aa06-1693-4a79-8ae9-07e433e93db8")]
                            receive (SendBasketPort.SendBasketOp, OrderMessage);
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("2e7735cd-43ec-4558-9ed1-8675c3bf67ac")]
                            retryCount = 3;
                        }
                        exceptions
                        {
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("97972509-a1dd-4067-91c2-ceb9026b953f")]
                            catch (SendBasketPort.SendBasketOp.BusinessFault OrderSystemBusinessException)
                            {
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("fb63d45a-bb33-49ef-8598-5e189bbb3a6f")]
                                terminate OrderSystemBusinessException.Message;;
                            }
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("24d8b91b-7ee0-4814-b866-ea3f9dbcb35e")]
                            catch (SendBasketPort.SendBasketOp.SystemFault OrderSystemSystemFault)
                            {
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("0958f0cb-b9cc-4ad2-89ba-527c888c37b4")]
                                retryCount = retryCount + 1;
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("8f379ecb-303a-47f8-a71a-f80085e9af1c")]
                                if (retryCount < 3)
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("80971834-6324-4e37-9ea1-7ab15ba8d7ef")]
                                    System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Failed to publish order to Order System. Orchestration Suspended." + OrderSystemSystemFault.Message, System.Diagnostics.EventLogEntryType.Warning);
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("8ed15101-e555-4161-9887-9a6eaea18fa9")]
                                    suspend "Please check if your connection to the Order system is configured correctly.";
                                }
                                else 
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("74e4e6b4-d3e5-4ac4-a082-a8ed4b04743f")]
                                    System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Failed to publish order to Order System after several retries. Orchestration Terminated." + OrderSystemSystemFault.Message, System.Diagnostics.EventLogEntryType.Error);
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("77fbb591-e6f3-4a54-985d-b2470f60ba8f")]
                                    terminate "Cannot fulfill order as call to submit basket failed.";;
                                }
                            }
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("3624b7d4-3a4e-477a-b58e-60aee40dd138")]
                            catch (System.Exception ex)
                            {
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("2309fd43-dbbd-453c-9b4a-0d4edfe68b72")]
                                retryCount = retryCount + 1;
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("90f99cdf-1abf-4726-b051-8adf831acd85")]
                                if (retryCount < 3)
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("7cd07531-10af-413f-b893-7a2727fe68d8")]
                                    System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Failed to publish order to Order System. Orchestration Suspended." + ex.Message, System.Diagnostics.EventLogEntryType.Warning);
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("76433813-a7eb-4250-b3f0-be34ca1fcf1b")]
                                    suspend "Please check if your connection to the Order system is configured correctly.";
                                }
                                else 
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("df622c8d-0061-46f3-8d26-9eeb9c1edc8a")]
                                    System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Failed to publish order to Order System after several retries. Orchestration Terminated." + ex.Message, System.Diagnostics.EventLogEntryType.Error);
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("f34fa091-096f-4f29-93d6-6b0f5c09724f")]
                                    terminate "Cannot fulfill order as call to submit basket failed.";;
                                }
                            }
                        }
                    }
                }
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("a7bbf9f3-f0a0-4762-a408-bc2d76e60640")]
                call Microsoft.Samples.BizTalk.Litware.Orchestrations.ConfirmOrderWithVendors (OrderMessage);
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("8f2d4634-79e5-4678-a85a-995691e90153")]
                call Microsoft.Samples.BizTalk.Litware.Orchestrations.ConfirmOrderWithBroker (brokerID, OrderMessage, destination);
            }
            else 
            {
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("46b61cc7-1f3b-4ed4-8c33-4eacc41fbfcc")]
                System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Unable to find partner profile with Broker ID = " + brokerID, System.Diagnostics.EventLogEntryType.Error);
            }
        }
    }
}

