#if __DESIGNER_DATA
#error Do not define __DESIGNER_DATA.
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<om:MetaModel MajorVersion="1" MinorVersion="3" Core="2b131234-7959-458d-834f-2dc0769ce683" ScheduleModel="66366196-361d-448d-976f-cab5e87496d2" xmlns:om="http://schemas.microsoft.com/BizTalk/2003/DesignerData">
    <om:Element Type="Module" OID="462ccee7-91ec-4514-84fe-aac64ab477a7" LowerBound="1.1" HigherBound="131.1">
        <om:Property Name="ReportToAnalyst" Value="True" />
        <om:Property Name="Name" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations" />
        <om:Property Name="Signal" Value="False" />
        <om:Element Type="ServiceDeclaration" OID="f99f7edf-46d4-4158-b76b-5e1f43d7ee23" ParentLink="Module_ServiceDeclaration" LowerBound="29.1" HigherBound="130.1">
            <om:Property Name="InitializedTransactionType" Value="False" />
            <om:Property Name="IsInvokable" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="UpdateUserProfileBAS" />
            <om:Property Name="Signal" Value="False" />
            <om:Element Type="VariableDeclaration" OID="17647593-b405-46e4-8302-a93ab06b0809" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="39.1" HigherBound="40.1">
                <om:Property Name="InitialValue" Value="0" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.Int32" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="retryCount" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="d222c2df-9a0d-4199-a6cd-b6ad975871e8" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="40.1" HigherBound="41.1">
                <om:Property Name="InitialValue" Value="null" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.String" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="parnterID" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="ecf6c532-b0a9-4d81-a22f-e491fb5b7086" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="41.1" HigherBound="42.1">
                <om:Property Name="InitialValue" Value="null" />
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="System.String" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="parnterIDLink" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="VariableDeclaration" OID="16ebaaf8-09d3-410b-842f-c626f575e9db" ParentLink="ServiceDeclaration_VariableDeclaration" LowerBound="42.1" HigherBound="43.1">
                <om:Property Name="UseDefaultConstructor" Value="False" />
                <om:Property Name="Type" Value="Microsoft.XLANGs.BaseTypes.Party" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="partner" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="ServiceLinkDeclaration" OID="be96d11d-0b4b-4473-97fe-2aeedfa560d4" ParentLink="ServiceDeclaration_ServiceLinkDeclaration" LowerBound="32.1" HigherBound="33.1">
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="1" />
                <om:Property Name="PortModifier" Value="Implements" />
                <om:Property Name="RoleName" Value="UpdateProfile_Role" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.UserProfileLinkType" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateProfileRoleLink" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="f9045ac7-c181-48c4-9f4f-958c3df26000" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="35.1" HigherBound="36.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="ProfileMessage" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="f5e45642-7c93-41fd-95c7-301adab93b32" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="36.1" HigherBound="37.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.TPMAccess.TPMAccess_.UpdatePartner_request" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateProfileRequest" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="d37d7ec7-1c60-4f82-a7b2-31bdf46fbb5f" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="37.1" HigherBound="38.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.TPMAccess.TPMAccess_.UpdatePartner_response" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateProfileResponse" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="MessageDeclaration" OID="b91c8ff8-393d-463a-b9d3-76d23fc6ea38" ParentLink="ServiceDeclaration_MessageDeclaration" LowerBound="38.1" HigherBound="39.1">
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.ProfileAck" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="ProfileAck" />
                <om:Property Name="Signal" Value="True" />
            </om:Element>
            <om:Element Type="ServiceBody" OID="598837f2-b382-43e3-abaa-457c30edecbe" ParentLink="ServiceDeclaration_ServiceBody">
                <om:Property Name="Signal" Value="False" />
                <om:Element Type="Receive" OID="b3c98235-f4ec-48bf-a997-ff1bf6371621" ParentLink="ServiceBody_Statement" LowerBound="45.1" HigherBound="50.1">
                    <om:Property Name="Activate" Value="True" />
                    <om:Property Name="MessageName" Value="ProfileMessage" />
                    <om:Property Name="OperationName" Value="Operation_Profile" />
                    <om:Property Name="OperationMessageName" Value="Request" />
                    <om:Property Name="ServiceLinkName" Value="UpdateProfileRoleLink" />
                    <om:Property Name="ServiceLinkPortTypeName" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfilePortType" />
                    <om:Property Name="ServiceLinkRoleName" Value="UpdateProfile_Role" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="ReceiveUpdateProfile" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="VariableAssignment" OID="e4a53c33-4d1f-4030-b9a1-276a67e1f126" ParentLink="ServiceBody_Statement" LowerBound="50.1" HigherBound="54.1">
                    <om:Property Name="Expression" Value="parnterID = ProfileMessage.PartnerId;&#xD;&#xA;partner = UpdateProfileRoleLink(Microsoft.XLANGs.BaseTypes.SourceParty);&#xD;&#xA;parnterIDLink = partner.Name;" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="GetPatnerID" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
                <om:Element Type="Decision" OID="126e8ff1-6246-424b-ba1e-0e50ebf25141" ParentLink="ServiceBody_Statement" LowerBound="54.1" HigherBound="128.1">
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Check Partner ID??" />
                    <om:Property Name="Signal" Value="True" />
                    <om:Element Type="DecisionBranch" OID="81c670de-b82c-4231-8919-0f33b8e247b8" ParentLink="ReallyComplexStatement_Branch" LowerBound="55.13" HigherBound="123.1">
                        <om:Property Name="Expression" Value="parnterIDLink == parnterID" />
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="IDCheckRule" />
                        <om:Property Name="Signal" Value="False" />
                        <om:Element Type="Construct" OID="1a2d0d42-be04-49cc-aaf1-20ee96500cc1" ParentLink="ComplexStatement_Statement" LowerBound="57.1" HigherBound="63.1">
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="ConstructUpdateUserMessage" />
                            <om:Property Name="Signal" Value="True" />
                            <om:Element Type="MessageRef" OID="6f840a10-5820-47af-b596-3847df2f8717" ParentLink="Construct_MessageRef" LowerBound="58.27" HigherBound="58.47">
                                <om:Property Name="Ref" Value="UpdateProfileRequest" />
                                <om:Property Name="ReportToAnalyst" Value="True" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                            <om:Element Type="MessageAssignment" OID="32b6e251-5d2a-4f3f-b00b-9819163daa03" ParentLink="ComplexStatement_Statement" LowerBound="60.1" HigherBound="62.1">
                                <om:Property Name="Expression" Value="UpdateProfileRequest.partnerXml = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.ConvertXmlToString(ProfileMessage);" />
                                <om:Property Name="ReportToAnalyst" Value="False" />
                                <om:Property Name="Name" Value="UpdateUserMessage" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                        </om:Element>
                        <om:Element Type="While" OID="08b62cfa-fac2-45a9-9205-cfd3184e76ab" ParentLink="ComplexStatement_Statement" LowerBound="63.1" HigherBound="112.1">
                            <om:Property Name="Expression" Value="retryCount &lt; 3" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="RetryLoop" />
                            <om:Property Name="Signal" Value="True" />
                            <om:Element Type="Scope" OID="103985b5-339d-4ea8-aacc-d88656df8ff9" ParentLink="ComplexStatement_Statement" LowerBound="66.1" HigherBound="111.1">
                                <om:Property Name="InitializedTransactionType" Value="True" />
                                <om:Property Name="IsSynchronized" Value="False" />
                                <om:Property Name="ReportToAnalyst" Value="True" />
                                <om:Property Name="Name" Value="UpdateTPMProfileScope" />
                                <om:Property Name="Signal" Value="True" />
                                <om:Element Type="Send" OID="44e0aef5-2e34-40f9-bb48-8a20ae3d47da" ParentLink="ComplexStatement_Statement" LowerBound="71.1" HigherBound="73.1">
                                    <om:Property Name="PortName" Value="UpdateProfilePort" />
                                    <om:Property Name="MessageName" Value="UpdateProfileRequest" />
                                    <om:Property Name="OperationName" Value="UpdatePartner" />
                                    <om:Property Name="OperationMessageName" Value="Request" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="SendProfileUpdate" />
                                    <om:Property Name="Signal" Value="True" />
                                </om:Element>
                                <om:Element Type="Receive" OID="3540b4c7-78c4-4a40-887f-2c0964581499" ParentLink="ComplexStatement_Statement" LowerBound="73.1" HigherBound="75.1">
                                    <om:Property Name="Activate" Value="False" />
                                    <om:Property Name="PortName" Value="UpdateProfilePort" />
                                    <om:Property Name="MessageName" Value="UpdateProfileResponse" />
                                    <om:Property Name="OperationName" Value="UpdatePartner" />
                                    <om:Property Name="OperationMessageName" Value="Response" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="AnalystComments" Value="Receive the status of request to create user profile." />
                                    <om:Property Name="Name" Value="ReceiveStatus" />
                                    <om:Property Name="Signal" Value="True" />
                                </om:Element>
                                <om:Element Type="VariableAssignment" OID="0cbf5e18-dbcf-4a63-865d-539de033f3d9" ParentLink="ComplexStatement_Statement" LowerBound="75.1" HigherBound="77.1">
                                    <om:Property Name="Expression" Value="retryCount = 3;" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="Breakloop" />
                                    <om:Property Name="Signal" Value="False" />
                                </om:Element>
                                <om:Element Type="Catch" OID="5c6a5be7-0601-4a6e-9da0-708f40de7933" ParentLink="Scope_Catch" LowerBound="80.1" HigherBound="109.1">
                                    <om:Property Name="ExceptionName" Value="exp" />
                                    <om:Property Name="ExceptionType" Value="System.Exception" />
                                    <om:Property Name="IsFaultMessage" Value="False" />
                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                    <om:Property Name="Name" Value="CatchNewProfileException" />
                                    <om:Property Name="Signal" Value="True" />
                                    <om:Element Type="VariableAssignment" OID="85ec94ba-c7eb-42ca-9f1d-fe6b0278e85d" ParentLink="Catch_Statement" LowerBound="83.1" HigherBound="85.1">
                                        <om:Property Name="Expression" Value="retryCount = retryCount + 1;" />
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Count" />
                                        <om:Property Name="Signal" Value="True" />
                                    </om:Element>
                                    <om:Element Type="Decision" OID="69be9578-8dbd-495c-9500-67a250940a0f" ParentLink="Catch_Statement" LowerBound="85.1" HigherBound="108.1">
                                        <om:Property Name="ReportToAnalyst" Value="True" />
                                        <om:Property Name="Name" Value="Terminate" />
                                        <om:Property Name="Signal" Value="True" />
                                        <om:Element Type="DecisionBranch" OID="2d67f2de-e28f-48ec-b260-dfd1dd75181b" ParentLink="ReallyComplexStatement_Branch" LowerBound="86.33" HigherBound="93.1">
                                            <om:Property Name="Expression" Value="retryCount &lt; 3" />
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="RetryOver" />
                                            <om:Property Name="Signal" Value="False" />
                                            <om:Element Type="VariableAssignment" OID="bc4a9739-cb73-4eda-8346-0b7c726e1bb4" ParentLink="ComplexStatement_Statement" LowerBound="88.1" HigherBound="90.1">
                                                <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Failed to update profile for commerce site. Orchestration Suspended.&quot;);" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="LogErrorInEventLog" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                            <om:Element Type="Suspend" OID="0a403d6f-583f-46fb-807d-227bcc15ed06" ParentLink="ComplexStatement_Statement" LowerBound="90.1" HigherBound="92.1">
                                                <om:Property Name="ErrorMessage" Value="&quot;Please verify why commerce profile adapter failed to create profile. &quot; + exp.Message;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="Suspend" />
                                                <om:Property Name="Signal" Value="False" />
                                            </om:Element>
                                        </om:Element>
                                        <om:Element Type="DecisionBranch" OID="3ba72cba-c2ba-413a-8234-4ab9c4c49a39" ParentLink="ReallyComplexStatement_Branch">
                                            <om:Property Name="IsGhostBranch" Value="True" />
                                            <om:Property Name="ReportToAnalyst" Value="True" />
                                            <om:Property Name="Name" Value="Else" />
                                            <om:Property Name="Signal" Value="False" />
                                            <om:Element Type="Construct" OID="b5c16357-ed3b-4ff7-9563-872261e48cdb" ParentLink="ComplexStatement_Statement" LowerBound="95.1" HigherBound="103.1">
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="ProfileAck" />
                                                <om:Property Name="Signal" Value="True" />
                                                <om:Element Type="MessageRef" OID="0f271c1b-884b-4beb-87a0-a613f988a39b" ParentLink="Construct_MessageRef" LowerBound="96.47" HigherBound="96.57">
                                                    <om:Property Name="Ref" Value="ProfileAck" />
                                                    <om:Property Name="ReportToAnalyst" Value="True" />
                                                    <om:Property Name="Signal" Value="False" />
                                                </om:Element>
                                                <om:Element Type="MessageAssignment" OID="776956af-20b0-4a11-ab81-9c28f4640224" ParentLink="ComplexStatement_Statement" LowerBound="98.1" HigherBound="102.1">
                                                    <om:Property Name="Expression" Value="ProfileAck = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyProfileAck();&#xD;&#xA;ProfileAck.PartnerName = parnterIDLink;&#xD;&#xA;ProfileAck.Result = false;" />
                                                    <om:Property Name="ReportToAnalyst" Value="False" />
                                                    <om:Property Name="Name" Value="MessageAssignment_1" />
                                                    <om:Property Name="Signal" Value="False" />
                                                </om:Element>
                                            </om:Element>
                                            <om:Element Type="Send" OID="a53bd2b4-8d88-4514-a40a-a35ac7811c08" ParentLink="ComplexStatement_Statement" LowerBound="103.1" HigherBound="105.1">
                                                <om:Property Name="MessageName" Value="ProfileAck" />
                                                <om:Property Name="OperationName" Value="Operation_Status" />
                                                <om:Property Name="OperationMessageName" Value="Request" />
                                                <om:Property Name="ServiceLinkName" Value="UpdateProfileRoleLink" />
                                                <om:Property Name="ServiceLinkPortTypeName" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfileStatusPortType" />
                                                <om:Property Name="ServiceLinkRoleName" Value="UpdateStatus_Role" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="AnalystComments" Value="Send manual intervention if failed to create the user profile." />
                                                <om:Property Name="Name" Value="SendFailedNotification" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                            <om:Element Type="Terminate" OID="81e22950-4e74-43bd-82b7-21c145226c72" ParentLink="ComplexStatement_Statement" LowerBound="105.1" HigherBound="107.1">
                                                <om:Property Name="ErrorMessage" Value="exp.Message;" />
                                                <om:Property Name="ReportToAnalyst" Value="True" />
                                                <om:Property Name="Name" Value="TerminateUpdate" />
                                                <om:Property Name="Signal" Value="True" />
                                            </om:Element>
                                        </om:Element>
                                    </om:Element>
                                </om:Element>
                            </om:Element>
                        </om:Element>
                        <om:Element Type="Construct" OID="a363d02c-da67-4f95-b414-a63548ede6bb" ParentLink="ComplexStatement_Statement" LowerBound="112.1" HigherBound="120.1">
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="ProfileAck" />
                            <om:Property Name="Signal" Value="True" />
                            <om:Element Type="MessageRef" OID="45af74cf-8ffb-4078-89a4-797932e8fefb" ParentLink="Construct_MessageRef" LowerBound="113.27" HigherBound="113.37">
                                <om:Property Name="Ref" Value="ProfileAck" />
                                <om:Property Name="ReportToAnalyst" Value="True" />
                                <om:Property Name="Signal" Value="False" />
                            </om:Element>
                            <om:Element Type="MessageAssignment" OID="6f71d70a-d20e-44ca-8d1f-da84d71c3d7b" ParentLink="ComplexStatement_Statement" LowerBound="115.1" HigherBound="119.1">
                                <om:Property Name="Expression" Value="ProfileAck = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyProfileAck();&#xD;&#xA;ProfileAck.PartnerName = parnterIDLink;&#xD;&#xA;ProfileAck.Result = true;" />
                                <om:Property Name="ReportToAnalyst" Value="False" />
                                <om:Property Name="Name" Value="MessageAssignment_1" />
                                <om:Property Name="Signal" Value="True" />
                            </om:Element>
                        </om:Element>
                        <om:Element Type="Send" OID="f6ef170b-e142-4180-b167-52afe3f6c84d" ParentLink="ComplexStatement_Statement" LowerBound="120.1" HigherBound="122.1">
                            <om:Property Name="MessageName" Value="ProfileAck" />
                            <om:Property Name="OperationName" Value="Operation_Status" />
                            <om:Property Name="OperationMessageName" Value="Request" />
                            <om:Property Name="ServiceLinkName" Value="UpdateProfileRoleLink" />
                            <om:Property Name="ServiceLinkPortTypeName" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfileStatusPortType" />
                            <om:Property Name="ServiceLinkRoleName" Value="UpdateStatus_Role" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="AnalystComments" Value="Send manual intervention if failed to create the user profile." />
                            <om:Property Name="Name" Value="SendSucessNotification" />
                            <om:Property Name="Signal" Value="True" />
                        </om:Element>
                    </om:Element>
                    <om:Element Type="DecisionBranch" OID="7ad09d1d-ccc2-449f-8ccc-76501a8b1455" ParentLink="ReallyComplexStatement_Branch">
                        <om:Property Name="IsGhostBranch" Value="True" />
                        <om:Property Name="ReportToAnalyst" Value="True" />
                        <om:Property Name="Name" Value="Else" />
                        <om:Property Name="Signal" Value="False" />
                        <om:Element Type="VariableAssignment" OID="63b4f8fd-06a9-455f-a699-ad979bb07d7b" ParentLink="ComplexStatement_Statement" LowerBound="125.1" HigherBound="127.1">
                            <om:Property Name="Expression" Value="System.Diagnostics.EventLog.WriteEntry(&quot;Litware Scenario&quot;, &quot;Partner &quot; + parnterIDLink + &quot; trying to update profile of user &quot; + parnterID + &quot;. Operation is not allowed.&quot;, System.Diagnostics.EventLogEntryType.Error);" />
                            <om:Property Name="ReportToAnalyst" Value="True" />
                            <om:Property Name="Name" Value="Notify Admin" />
                            <om:Property Name="Signal" Value="False" />
                        </om:Element>
                    </om:Element>
                </om:Element>
            </om:Element>
            <om:Element Type="PortDeclaration" OID="ff402ce5-8467-40f9-a21c-36f88a8af2d7" ParentLink="ServiceDeclaration_PortDeclaration" LowerBound="33.1" HigherBound="35.1">
                <om:Property Name="PortModifier" Value="Uses" />
                <om:Property Name="Orientation" Value="Left" />
                <om:Property Name="PortIndex" Value="12" />
                <om:Property Name="IsWebPort" Value="True" />
                <om:Property Name="OrderedDelivery" Value="False" />
                <om:Property Name="DeliveryNotification" Value="None" />
                <om:Property Name="Type" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.TPMAccess.TPMAccess_.TPMAccess" />
                <om:Property Name="ParamDirection" Value="In" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateProfilePort" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="LogicalBindingAttribute" OID="356280f0-9578-440e-9948-33ac1e4c19c4" ParentLink="PortDeclaration_CLRAttribute" LowerBound="33.1" HigherBound="34.1">
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="ServiceLinkType" OID="94a44659-27ca-43b3-81f4-bc9f08672fb2" ParentLink="Module_ServiceLinkType" LowerBound="18.1" HigherBound="29.1">
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="UserProfileLinkType" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="RoleDeclaration" OID="9aefba94-ef6b-4a9e-8a35-914cce1ab479" ParentLink="ServiceLinkType_RoleDeclaration" LowerBound="20.1" HigherBound="24.1">
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateProfile_Role" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="PortTypeRef" OID="4bdc494a-ccba-4b71-8d55-6d07d15596c6" ParentLink="RoleDeclaration_PortTypeRef" LowerBound="22.13" HigherBound="22.28">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfilePortType" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="PortTypeRef_1" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
            <om:Element Type="RoleDeclaration" OID="a7e65688-519d-4042-8a3e-da65a9f30db5" ParentLink="ServiceLinkType_RoleDeclaration" LowerBound="24.1" HigherBound="28.1">
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="UpdateStatus_Role" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="PortTypeRef" OID="bb93acbd-ca07-4155-b5fa-357555ddfe71" ParentLink="RoleDeclaration_PortTypeRef" LowerBound="26.13" HigherBound="26.34">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfileStatusPortType" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="PortTypeRef_1" />
                    <om:Property Name="Signal" Value="False" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="PortType" OID="f506526f-7150-4e03-9de6-e6fec1c3c8c9" ParentLink="Module_PortType" LowerBound="4.1" HigherBound="11.1">
            <om:Property Name="Synchronous" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="ProfilePortType" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="OperationDeclaration" OID="ca7a401e-fa34-4dc6-9226-1c4122e4ef5b" ParentLink="PortType_OperationDeclaration" LowerBound="6.1" HigherBound="10.1">
                <om:Property Name="OperationType" Value="OneWay" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="Operation_Profile" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="MessageRef" OID="e8583d83-3777-4777-8399-7462adb4a398" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="8.13" HigherBound="8.80">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
            </om:Element>
        </om:Element>
        <om:Element Type="PortType" OID="502e5187-7c79-4f39-9e2f-b3c5a55b609a" ParentLink="Module_PortType" LowerBound="11.1" HigherBound="18.1">
            <om:Property Name="Synchronous" Value="False" />
            <om:Property Name="TypeModifier" Value="Internal" />
            <om:Property Name="ReportToAnalyst" Value="True" />
            <om:Property Name="Name" Value="ProfileStatusPortType" />
            <om:Property Name="Signal" Value="True" />
            <om:Element Type="OperationDeclaration" OID="f98aa7e6-f84d-408b-935b-f4f36386451f" ParentLink="PortType_OperationDeclaration" LowerBound="13.1" HigherBound="17.1">
                <om:Property Name="OperationType" Value="OneWay" />
                <om:Property Name="ReportToAnalyst" Value="True" />
                <om:Property Name="Name" Value="Operation_Status" />
                <om:Property Name="Signal" Value="True" />
                <om:Element Type="MessageRef" OID="42bdf8bd-9110-4a7b-8bed-5de632cdf971" ParentLink="OperationDeclaration_RequestMessageRef" LowerBound="15.13" HigherBound="15.69">
                    <om:Property Name="Ref" Value="Microsoft.Samples.BizTalk.Litware.Schemas.TPM.ProfileAck" />
                    <om:Property Name="ReportToAnalyst" Value="True" />
                    <om:Property Name="Name" Value="Request" />
                    <om:Property Name="Signal" Value="True" />
                </om:Element>
            </om:Element>
        </om:Element>
    </om:Element>
</om:MetaModel>
#endif // __DESIGNER_DATA
[Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
module Microsoft.Samples.BizTalk.Litware.Orchestrations
{
    internal porttype ProfilePortType
    {
        oneway Operation_Profile
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject
        };
    };
    internal porttype ProfileStatusPortType
    {
        oneway Operation_Status
        {
            Microsoft.Samples.BizTalk.Litware.Schemas.TPM.ProfileAck
        };
    };
    internal servicelinktype UserProfileLinkType
    {
        UpdateProfile_Role
        {
            ProfilePortType
        };
        UpdateStatus_Role
        {
            ProfileStatusPortType
        };
    };
    [Microsoft.XLANGs.BaseTypes.BPELExportable(false)]
    internal service UpdateUserProfileBAS
    {
        servicelink implements UserProfileLinkType.UpdateProfile_Role UpdateProfileRoleLink;
        [Microsoft.XLANGs.BaseTypes.LogicalBinding()]
        port uses TPMAccess.TPMAccess_.TPMAccess UpdateProfilePort;
        message Microsoft.Samples.BizTalk.Litware.Schemas.TPM.Partner.PartnerObject ProfileMessage;
        message TPMAccess.TPMAccess_.UpdatePartner_request UpdateProfileRequest;
        message TPMAccess.TPMAccess_.UpdatePartner_response UpdateProfileResponse;
        message Microsoft.Samples.BizTalk.Litware.Schemas.TPM.ProfileAck ProfileAck;
        System.Int32 retryCount;
        System.String parnterID;
        System.String parnterIDLink;
        Microsoft.XLANGs.BaseTypes.Party partner;
        body ()
        {
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("b3c98235-f4ec-48bf-a997-ff1bf6371621")]
            activate receive (UpdateProfileRoleLink[Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfilePortType].Operation_Profile, ProfileMessage);
            retryCount = 0;
            parnterID = null;
            parnterIDLink = null;
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("e4a53c33-4d1f-4030-b9a1-276a67e1f126")]
            parnterID = ProfileMessage.PartnerId;
            partner = UpdateProfileRoleLink(Microsoft.XLANGs.BaseTypes.SourceParty);
            parnterIDLink = partner.Name;
            [Microsoft.XLANGs.BaseTypes.DesignerPosition("126e8ff1-6246-424b-ba1e-0e50ebf25141")]
            if (parnterIDLink == parnterID)
            {
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("1a2d0d42-be04-49cc-aaf1-20ee96500cc1")]
                construct UpdateProfileRequest
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("32b6e251-5d2a-4f3f-b00b-9819163daa03")]
                    UpdateProfileRequest.partnerXml = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.ConvertXmlToString(ProfileMessage);
                }
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("08b62cfa-fac2-45a9-9205-cfd3184e76ab")]
                while (retryCount < 3)
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("103985b5-339d-4ea8-aacc-d88656df8ff9")]
                    scope
                    {
                        body
                        {
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("44e0aef5-2e34-40f9-bb48-8a20ae3d47da")]
                            send (UpdateProfilePort.UpdatePartner, UpdateProfileRequest);
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("3540b4c7-78c4-4a40-887f-2c0964581499")]
                            receive (UpdateProfilePort.UpdatePartner, UpdateProfileResponse);
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("0cbf5e18-dbcf-4a63-865d-539de033f3d9")]
                            retryCount = 3;
                        }
                        exceptions
                        {
                            [Microsoft.XLANGs.BaseTypes.DesignerPosition("5c6a5be7-0601-4a6e-9da0-708f40de7933")]
                            catch (System.Exception exp)
                            {
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("85ec94ba-c7eb-42ca-9f1d-fe6b0278e85d")]
                                retryCount = retryCount + 1;
                                [Microsoft.XLANGs.BaseTypes.DesignerPosition("69be9578-8dbd-495c-9500-67a250940a0f")]
                                if (retryCount < 3)
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("bc4a9739-cb73-4eda-8346-0b7c726e1bb4")]
                                    System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Failed to update profile for commerce site. Orchestration Suspended.");
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("0a403d6f-583f-46fb-807d-227bcc15ed06")]
                                    suspend "Please verify why commerce profile adapter failed to create profile. " + exp.Message;
                                }
                                else 
                                {
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("b5c16357-ed3b-4ff7-9563-872261e48cdb")]
                                    construct ProfileAck
                                    {
                                        [Microsoft.XLANGs.BaseTypes.DesignerPosition("776956af-20b0-4a11-ab81-9c28f4640224")]
                                        ProfileAck = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyProfileAck();
                                        ProfileAck.PartnerName = parnterIDLink;
                                        ProfileAck.Result = false;
                                    }
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("a53bd2b4-8d88-4514-a40a-a35ac7811c08")]
                                    send (UpdateProfileRoleLink[Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfileStatusPortType].Operation_Status, ProfileAck);
                                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("81e22950-4e74-43bd-82b7-21c145226c72")]
                                    terminate exp.Message;;
                                }
                            }
                        }
                    }
                }
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("a363d02c-da67-4f95-b414-a63548ede6bb")]
                construct ProfileAck
                {
                    [Microsoft.XLANGs.BaseTypes.DesignerPosition("6f71d70a-d20e-44ca-8d1f-da84d71c3d7b")]
                    ProfileAck = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyProfileAck();
                    ProfileAck.PartnerName = parnterIDLink;
                    ProfileAck.Result = true;
                }
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("f6ef170b-e142-4180-b167-52afe3f6c84d")]
                send (UpdateProfileRoleLink[Microsoft.Samples.BizTalk.Litware.Orchestrations.ProfileStatusPortType].Operation_Status, ProfileAck);
            }
            else 
            {
                [Microsoft.XLANGs.BaseTypes.DesignerPosition("63b4f8fd-06a9-455f-a699-ad979bb07d7b")]
                System.Diagnostics.EventLog.WriteEntry("Litware Scenario", "Partner " + parnterIDLink + " trying to update profile of user " + parnterID + ". Operation is not allowed.", System.Diagnostics.EventLogEntryType.Error);
            }
        }
    }
}

